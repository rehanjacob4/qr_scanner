<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Item QR Code Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- ZXing -->
<script src="https://unpkg.com/@zxing/library@latest"></script>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f4f6f8;
}
header {
  background: #1f2937;
  color: white;
  text-align: center;
  font-size: 22px;
  padding: 14px;
  font-weight: bold;
}
.screen { display: none; padding: 15px; }
.active { display: block; }

button {
  width: 100%;
  padding: 16px;
  margin: 8px 0;
  font-size: 17px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
}
.primary { background:#2563eb; color:white; }
.secondary { background:#10b981; color:white; }
.gray { background:#6b7280; color:white; }
.danger { background:#dc2626; color:white; }

video {
  width: 100%;
  border-radius: 8px;
  margin-bottom: 10px;
}

.list {
  background:white;
  border-radius:6px;
  padding:10px;
  max-height:220px;
  overflow-y:auto;
}
.item {
  padding:6px;
  border-bottom:1px solid #e5e7eb;
  font-size:14px;
}

#duplicateBox {
  display:none;
  background:#fff3cd;
  border:1px solid #facc15;
  padding:10px;
  border-radius:6px;
  margin-bottom:10px;
}

#logBox {
  background:#111827;
  color:#e5e7eb;
  padding:10px;
  border-radius:6px;
  font-size:13px;
  max-height:160px;
  overflow-y:auto;
}
</style>
</head>

<body>

<header>Item QR Code Scanner</header>

<!-- MAIN MENU -->
<div id="mainMenu" class="screen active">
  <button class="primary" onclick="showScreen('newSession')">Start New Session</button>
  <button class="secondary" onclick="showSavedSessions()">Open Saved Sessions</button>
  <button class="gray" onclick="showScreen('settings')">Settings</button>

  <div id="logBox">
    <b>System Log</b>
    <div id="log"></div>
  </div>
</div>

<!-- NEW SESSION -->
<div id="newSession" class="screen">
  <button class="primary" onclick="startSession()">Use Camera (Mobile)</button>
  <button class="gray" onclick="showScreen('mainMenu')">Back</button>
</div>

<!-- SESSION -->
<div id="sessionScreen" class="screen">
  <h3 id="sessionTitle"></h3>

  <video id="video" muted playsinline></video>

  <div id="duplicateBox">
    <b>Duplicate detected</b>
    <button class="primary" onclick="acceptDuplicate()">Record Duplicate</button>
    <button class="gray" onclick="skipDuplicate()">Ignore</button>
  </div>

  <div class="list" id="scanList"></div>

  <button class="secondary" onclick="manualEntry()">Add Manual Entry</button>
  <button class="primary" onclick="saveSession()">Save & Exit</button>
  <button class="danger" onclick="cancelSession()">Cancel Session</button>
</div>

<!-- SAVED -->
<div id="savedSessions" class="screen">
  <div id="sessionsList"></div>
  <button class="gray" onclick="showScreen('mainMenu')">Back</button>
</div>

<!-- SETTINGS -->
<div id="settings" class="screen">
  <label>Separator Symbol</label>
  <input id="separator" style="width:100%;padding:12px;font-size:16px;" />
  <button class="primary" onclick="saveSettings()">Save</button>
  <button class="gray" onclick="showScreen('mainMenu')">Back</button>
</div>

<script>
/* ---------------- STATE ---------------- */
let currentSession = null;
let separator = localStorage.getItem("separator") || "_";
document.getElementById("separator").value = separator;

let lastProcessedQr = null;
let pendingDuplicate = null;

/* ZXing */
const codeReader = new ZXing.BrowserMultiFormatReader();

/* ---------------- LOG ---------------- */
function log(msg, color="#e5e7eb") {
  const d = document.createElement("div");
  d.style.color = color;
  d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  document.getElementById("log").prepend(d);
}
const logInfo = m => log("ℹ️ " + m, "#60a5fa");
const logOk   = m => log("✅ " + m, "#10b981");

/* ---------------- NAV ---------------- */
function showScreen(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* ---------------- SESSION ---------------- */
function startSession() {
  const name = prompt("Enter Session Name");
  if (!name) return;

  currentSession = {
    name,
    created: new Date().toLocaleString(),
    items: []
  };

  document.getElementById("sessionTitle").textContent =
    `${name} (${currentSession.created})`;

  showScreen("sessionScreen");
  document.getElementById("scanList").innerHTML = "";
  startCamera();
}

/* ---------------- ZXING SCANNER ---------------- */
async function startCamera() {
  logInfo("Starting ZXing scanner");

  const devices = await codeReader.listVideoInputDevices();
  const backCam = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];

  codeReader.decodeFromVideoDevice(
    backCam.deviceId,
    "video",
    (result, err) => {
      if (result) handleScan(result.text);
      if (err && err.name === "NotFoundException") {
        lastProcessedQr = null; // QR removed
      }
    }
  );
}

/* ---------------- SCAN HANDLING ---------------- */
function handleScan(text) {
  if (text === lastProcessedQr) return;

  lastProcessedQr = text;

  if (currentSession.items.includes(text)) {
    pendingDuplicate = text;
    document.getElementById("duplicateBox").style.display = "block";
    logInfo("Duplicate detected");
    return;
  }

  recordValue(text);
}

function recordValue(val) {
  currentSession.items.push(val);
  renderList();
  logOk("Item recorded");
}

/* ---------------- DUPLICATE UI ---------------- */
function acceptDuplicate() {
  recordValue(pendingDuplicate);
  clearDuplicate();
}

function skipDuplicate() {
  logInfo("Duplicate skipped");
  clearDuplicate();
}

function clearDuplicate() {
  pendingDuplicate = null;
  document.getElementById("duplicateBox").style.display = "none";
}

/* ---------------- LIST ---------------- */
function renderList() {
  const list = document.getElementById("scanList");
  list.innerHTML = "";
  currentSession.items.forEach((v,i) => {
    const d = document.createElement("div");
    d.className = "item";
    d.textContent = `${i+1}. ${v}`;
    list.appendChild(d);
  });
}

/* ---------------- MANUAL ---------------- */
function manualEntry() {
  const v = prompt("Enter QR value manually");
  if (v) recordValue(v);
}

/* ---------------- STORAGE ---------------- */
function saveSession() {
  const s = JSON.parse(localStorage.getItem("sessions") || "[]");
  s.push(currentSession);
  localStorage.setItem("sessions", JSON.stringify(s));
  showScreen("mainMenu");
}

function cancelSession() {
  if (confirm("Discard this session?")) showScreen("mainMenu");
}

function showSavedSessions() {
  showScreen("savedSessions");
  const box = document.getElementById("sessionsList");
  box.innerHTML = "";

  const s = JSON.parse(localStorage.getItem("sessions") || "[]");
  s.forEach((x,i) => {
    const d = document.createElement("div");
    d.className = "item";
    d.innerHTML = `
      <b>${x.name}</b> (${x.items.length})
      <br>
      <button onclick="exportSession(${i})">Export</button>
      <button onclick="deleteSession(${i})">Delete</button>
    `;
    box.appendChild(d);
  });
}

function deleteSession(i) {
  const s = JSON.parse(localStorage.getItem("sessions"));
  s.splice(i,1);
  localStorage.setItem("sessions", JSON.stringify(s));
  showSavedSessions();
}

function exportSession(i) {
  const s = JSON.parse(localStorage.getItem("sessions"))[i];
  const data = s.items.map(v => v.includes(separator) ? v.split(separator) : [v]);
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, s.name);
  XLSX.writeFile(wb, `${s.name}.xlsx`);
}

/* ---------------- SETTINGS ---------------- */
function saveSettings() {
  separator = document.getElementById("separator").value;
  localStorage.setItem("separator", separator);
  alert("Settings saved");
}
</script>

</body>
</html>
