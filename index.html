<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Item QR Code Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f4f6f8;
}
header {
  text-align: center;
  font-size: 24px;
  font-weight: bold;
  padding: 15px;
  background: #1f2937;
  color: white;
}
.screen {
  display: none;
  padding: 15px;
}
.active {
  display: block;
}
button {
  width: 100%;
  padding: 18px;
  margin: 10px 0;
  font-size: 18px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
}
.primary { background: #2563eb; color: white; }
.secondary { background: #10b981; color: white; }
.danger { background: #dc2626; color: white; }
.gray { background: #6b7280; color: white; }

.list {
  max-height: 250px;
  overflow-y: auto;
  background: white;
  padding: 10px;
  border-radius: 6px;
}
.item {
  padding: 8px;
  border-bottom: 1px solid #e5e7eb;
}
.small-btn {
  padding: 10px;
  font-size: 16px;
}

#logBox {
  margin-top: 15px;
  background: #111827;
  color: #e5e7eb;
  padding: 10px;
  border-radius: 6px;
  font-size: 14px;
  max-height: 160px;
  overflow-y: auto;
}
</style>
</head>

<body>

<header>Item QR Code Scanner</header>

<!-- MAIN MENU -->
<div id="mainMenu" class="screen active">
  <button class="primary" onclick="showScreen('newSession')">Start New Session</button>
  <button class="secondary" onclick="showSavedSessions()">Open Saved Sessions</button>
  <button class="gray" onclick="showScreen('settings')">Settings</button>

  <div id="logBox">
    <b>System Log</b>
    <div id="logMessages"></div>
  </div>
</div>

<!-- NEW SESSION -->
<div id="newSession" class="screen">
  <button class="primary" onclick="startSession('camera')">Use Camera (Mobile)</button>
  <button class="secondary" onclick="startSession('scanner')">Use Barcode Scanner (PC)</button>
  <button class="gray" onclick="backToMain()">Back</button>
</div>

<!-- SESSION SCREEN -->
<div id="sessionScreen" class="screen">
  <h3 id="sessionTitle"></h3>

  <div id="reader" style="width:100%;"></div>

  <button class="secondary small-btn" onclick="manualEntry()">Add Manual Entry</button>

  <div class="list" id="scanList"></div>

  <button class="primary" onclick="saveSession()">Save & Exit</button>
  <button class="danger" onclick="cancelSession()">Cancel Session</button>
</div>

<!-- SAVED SESSIONS -->
<div id="savedSessions" class="screen">
  <div id="sessionsList"></div>
  <button class="gray" onclick="backToMain()">Back</button>
</div>

<!-- SETTINGS -->
<div id="settings" class="screen">
  <label>Separator Symbol:</label>
  <input id="separator" style="width:100%;padding:12px;font-size:18px;">
  <button class="primary" onclick="saveSettings()">Save</button>
  <button class="gray" onclick="backToMain()">Back</button>
</div>

<script>
/* -------------------- LOGGING -------------------- */
function log(msg, color="#e5e7eb") {
  const box = document.getElementById("logMessages");
  if (!box) return;
  const div = document.createElement("div");
  div.style.color = color;
  div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  box.prepend(div);
}
const logInfo = m => log("ℹ️ " + m, "#60a5fa");
const logOk   = m => log("✅ " + m, "#10b981");
const logErr  = m => log("❌ " + m, "#ef4444");

/* -------------------- GLOBAL ERROR TRACKING -------------------- */
window.addEventListener("error", e => logErr("JS Error: " + e.message));
window.addEventListener("unhandledrejection", e => logErr("Promise Rejection"));

/* -------------------- STATE -------------------- */
let html5Qr = null;
let currentSession = null;
let separator = localStorage.getItem("separator") || "_";
document.getElementById("separator").value = separator;

let successSound = null;
let warningSound = null;
let audioReady = false;

let lastScanTime = 0;
const SCAN_DELAY = 800;

/* -------------------- AUDIO -------------------- */
  
function initAudio() {
  if (audioReady) return;
  successSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
  warningSound = new Audio("https://actions.google.com/sounds/v1/cartoon/instrument_strum.ogg");
  audioReady = true;
  logOk("Audio initialized");
}
function beep() {
  if (!successSound) return;
  successSound.currentTime = 0;
  successSound.play().catch(()=>{});
}
function warningBeep() {
  if (!warningSound) return;
  warningSound.currentTime = 0;
  warningSound.play().catch(()=>{});
}

/* -------------------- NAVIGATION -------------------- */
async function showScreen(id) {
  logInfo("Switching to: " + id);
  initAudio();
  await stopScanner();

  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  logOk("Screen loaded: " + id);
}
function backToMain() {
  showScreen("mainMenu");
}

/* -------------------- SESSION -------------------- */
function startSession(mode) {
  const name = prompt("Enter Session Name:");
  if (!name) return;

  currentSession = {
    name,
    created: new Date().toLocaleString(),
    items: []
  };

  document.getElementById("sessionTitle").textContent =
    `${name} (${currentSession.created})`;

  showScreen("sessionScreen");
  document.getElementById("scanList").innerHTML = "";

  if (mode === "camera") startCamera();
}

/* -------------------- CAMERA -------------------- */
function startCamera() {
  logInfo("Starting camera");
  html5Qr = new Html5Qrcode("reader");

  html5Qr.start(
    { facingMode: { exact: "environment" } },
    { fps: 15, qrbox: 250 },
    onScanSuccess
  ).catch(() => {
    html5Qr.start(
      { facingMode: "environment" },
      { fps: 15, qrbox: 250 },
      onScanSuccess
    );
  });
}

async function stopScanner() {
  if (!html5Qr) return;
  try {
    await html5Qr.stop();
    await html5Qr.clear();
    logOk("Scanner stopped");
  } catch {
    logErr("Scanner stop failed");
  }
  html5Qr = null;
}

/* -------------------- SCAN HANDLING -------------------- */
function onScanSuccess(text) {
  const now = Date.now();
  if (now - lastScanTime < SCAN_DELAY) return;
  lastScanTime = now;

  if (currentSession.items.includes(text)) {
    warningBeep();
    if (!confirm("Duplicate detected.\nOK = Save | Cancel = Skip")) return;
  } else {
    beep();
  }

  currentSession.items.push(text);
  renderList();
}

function renderList() {
  const list = document.getElementById("scanList");
  list.innerHTML = "";
  currentSession.items.forEach((v,i) => {
    const d = document.createElement("div");
    d.className = "item";
    d.textContent = `${i+1}. ${v}`;
    list.appendChild(d);
  });
}

async function manualEntry() {
  if (html5Qr) await html5Qr.pause(true);
  const v = prompt("Enter QR value:");
  if (v) {
    currentSession.items.push(v);
    renderList();
    beep();
  }
  if (html5Qr) await html5Qr.resume();
}

/* -------------------- STORAGE -------------------- */
function saveSession() {
  const sessions = JSON.parse(localStorage.getItem("sessions") || "[]");
  sessions.push(currentSession);
  localStorage.setItem("sessions", JSON.stringify(sessions));
  logOk("Session saved");
  backToMain();
}

function cancelSession() {
  if (confirm("All data will be lost. Continue?")) backToMain();
}

function showSavedSessions() {
  showScreen("savedSessions");
  const box = document.getElementById("sessionsList");
  box.innerHTML = "";

  const sessions = JSON.parse(localStorage.getItem("sessions") || "[]");
  sessions.forEach((s,i) => {
    const d = document.createElement("div");
    d.className = "item";
    d.innerHTML = `
      <b>${s.name}</b> (${s.items.length})
      <br>
      <button onclick="openSession(${i})">Open</button>
      <button onclick="exportSession(${i})">Export</button>
      <button onclick="deleteSession(${i})">Delete</button>`;
    box.appendChild(d);
  });
}

function openSession(i) {
  currentSession = JSON.parse(localStorage.getItem("sessions"))[i];
  showScreen("sessionScreen");
  renderList();
}

function deleteSession(i) {
  const sessions = JSON.parse(localStorage.getItem("sessions"));
  sessions.splice(i,1);
  localStorage.setItem("sessions", JSON.stringify(sessions));
  showSavedSessions();
}

function exportSession(i) {
  const s = JSON.parse(localStorage.getItem("sessions"))[i];
  const data = s.items.map(v => v.includes(separator) ? v.split(separator) : [v]);
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, s.name);
  XLSX.writeFile(wb, `${s.name}.xlsx`);
}

/* -------------------- SETTINGS -------------------- */
function saveSettings() {
  separator = document.getElementById("separator").value;
  localStorage.setItem("separator", separator);
  alert("Settings saved");
}
</script>

</body>
</html>
