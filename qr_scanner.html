<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>QR Scanner ‚Üí Excel</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, Arial;
    background: linear-gradient(to bottom, #e3f2fd, #ffffff);
    margin: 0;
    padding: 10px;
    text-align: center;
}

h2 {
    color: #0d47a1;
    margin-bottom: 10px;
}

#reader {
    width: 90%;
    max-width: 350px;
    margin: auto;
    border: 3px solid #2196f3;
    border-radius: 12px;
    background: black;
}

table {
    width: 100%;
    margin-top: 15px;
    background: white;
    border-collapse: collapse;
    font-size: 16px;
}

th, td {
    border: 1px solid #bbb;
    padding: 10px;
}

th {
    background: #bbdefb;
}

button {
    width: 90%;
    max-width: 300px;
    padding: 15px;
    margin: 10px auto;
    font-size: 18px;
    border-radius: 12px;
    border: none;
    color: white;
}

#startBtn {
    background: #4caf50;
}

#cancelBtn {
    background: #f44336;
}

#saveBtn {
    background: #2196f3;
}

#duplicateBox {
    display: none;
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border: 3px solid red;
    padding: 20px;
    border-radius: 10px;
    z-index: 1000;
    width: 80%;
}
</style>
</head>

<body>

<h2>üì∑ QR Scanner ‚Üí Excel</h2>

<button id="startBtn" onclick="startScanner()">‚ñ∂ Start Scanning</button>

<div id="reader"></div>

<table>
<thead>
<tr><th>Scanned QR Data</th></tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<button id="cancelBtn" onclick="cancelSession()">‚ùå Cancel Session</button>
<button id="saveBtn" onclick="exportToExcel()">üíæ Save & Export Excel</button>

<!-- Sounds -->
<audio id="normalBeep">
<source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg">
</audio>

<audio id="warningBeep">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<!-- Duplicate Box -->
<div id="duplicateBox">
    <p><b>‚ö† Duplicate QR Detected</b></p>
    <p id="dupText"></p>
    <button style="background:#4caf50" onclick="acceptDuplicate()">Accept</button>
    <button style="background:#f44336" onclick="rejectDuplicate()">Reject</button>
</div>

<script>

let scannedData = [];
let pendingDuplicate = "";
let html5QrCode;

// Start scanning
function startScanner() {

    html5QrCode = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(cameras => {
        html5QrCode.start(
            cameras[0].id,
            { fps: 10, qrbox: 250 },
            onScanSuccess
        );
    }).catch(err => alert("Camera error: " + err));
}

// When QR scanned
function onScanSuccess(decodedText) {

    if (scannedData.includes(decodedText)) {
        document.getElementById("warningBeep").play();
        pendingDuplicate = decodedText;
        document.getElementById("dupText").innerText = decodedText;
        document.getElementById("duplicateBox").style.display = "block";
        return;
    }

    addData(decodedText);
}

// Add normally
function addData(value) {

    scannedData.push(value);
    document.getElementById("normalBeep").play();

    let row = document.getElementById("tableBody").insertRow();
    let cell = row.insertCell(0);
    cell.innerText = value;
}

// Accept duplicate
function acceptDuplicate() {
    addData(pendingDuplicate);
    closeDuplicate();
}

// Reject duplicate
function rejectDuplicate() {
    closeDuplicate();
}

// Close popup
function closeDuplicate() {
    pendingDuplicate = "";
    document.getElementById("duplicateBox").style.display = "none";
}

// Cancel
function cancelSession() {
    if (confirm("Clear all scanned data?")) {
        scannedData = [];
        document.getElementById("tableBody").innerHTML = "";
    }
}

// Export Excel
function exportToExcel() {

    if (scannedData.length === 0) {
        alert("No data to export");
        return;
    }

    let excelData = scannedData.map(v => [v]);
    let ws = XLSX.utils.aoa_to_sheet([["Scanned QR Data"], ...excelData]);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "QR Scans");

    XLSX.writeFile(wb, "qr_scans.xlsx");

    if (html5QrCode) html5QrCode.stop();

    alert("Excel exported successfully!");
}

</script>

</body>
</html>
